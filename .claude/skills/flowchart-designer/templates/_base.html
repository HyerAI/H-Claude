<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{CHART_TITLE}}</title>
    <style>
        /* === BASE STYLES === */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            font-family: system-ui, -apple-system, sans-serif;
            color: #fff;
            min-height: 100vh;
        }

        /* === HEADER === */
        .header {
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .header-controls {
            display: flex;
            gap: 8px;
        }

        .header-controls button {
            padding: 8px 16px;
            border: 1px solid rgba(255,255,255,0.3);
            background: transparent;
            color: #fff;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .header-controls button:hover,
        .header-controls button.active {
            background: rgba(255,255,255,0.1);
            border-color: #74b9ff;
        }

        /* === CANVAS === */
        .canvas-wrapper {
            position: relative;
            width: 100%;
            height: calc(100vh - 80px);
            overflow: hidden;
        }

        .canvas {
            position: absolute;
            transform-origin: 0 0;
            transition: transform 0.1s;
        }

        /* === EDGES (SVG) === */
        .edges-svg {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .edge {
            fill: none;
            stroke-width: 2;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .edge-label {
            font-size: 10px;
            fill: #ccc;
        }

        .edge-label-bg {
            fill: rgba(0,0,0,0.85);
        }

        /* === NODES === */
        .node {
            position: absolute;
            cursor: pointer;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s;
        }

        .node:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        .node.selected {
            box-shadow: 0 0 0 3px #fff, 0 6px 20px rgba(0,0,0,0.4);
        }

        .node.disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        .node-label {
            font-size: 12px;
            font-weight: 600;
            padding: 0 8px;
        }

        .node-sublabel {
            font-size: 10px;
            opacity: 0.8;
            margin-top: 2px;
        }

        /* === PATTERN NODES === */
        .pattern-node {
            border: 2px dashed rgba(255,255,255,0.5);
            background: linear-gradient(135deg, rgba(100,100,120,0.3) 0%, rgba(80,80,100,0.3) 100%);
        }

        /* === DETAIL PANEL === */
        .detail-panel {
            position: fixed;
            right: 0;
            top: 80px;
            width: 300px;
            height: calc(100vh - 80px);
            background: rgba(0,0,0,0.9);
            border-left: 1px solid rgba(255,255,255,0.1);
            padding: 20px;
            transform: translateX(100%);
            transition: transform 0.3s;
            overflow-y: auto;
        }

        .detail-panel.open {
            transform: translateX(0);
        }

        .detail-panel h2 {
            font-size: 18px;
            margin-bottom: 12px;
        }

        .detail-section {
            margin-bottom: 20px;
        }

        .detail-section h3 {
            font-size: 12px;
            text-transform: uppercase;
            color: #888;
            margin-bottom: 8px;
        }

        .detail-section p {
            font-size: 14px;
            line-height: 1.5;
        }

        /* === LOOP BADGES === */
        .loop-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        /* === MODAL === */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.open {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.7;
        }

        .modal-close:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            max-height: 60vh;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>{{CHART_TITLE}}</h1>
        <div class="header-controls">
            <button class="active" onclick="filterAll()">All</button>
            <!-- Filter buttons injected by JS -->
        </div>
    </div>

    <div class="canvas-wrapper">
        <div class="canvas" id="canvas">
            <svg class="edges-svg" id="edges-svg">
                <defs>
                    <marker id="arrowhead" viewBox="0 0 10 10" refX="10" refY="5"
                            markerWidth="5" markerHeight="5" orient="auto-start-reverse">
                        <path d="M 0 0 L 10 5 L 0 10 z" fill="#888"/>
                    </marker>
                </defs>
            </svg>
            <!-- Nodes injected by JS -->
        </div>
    </div>

    <div class="detail-panel" id="detail-panel">
        <h2 id="detail-title">Select a node</h2>
        <div id="detail-content"></div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Details</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
        </div>
    </div>

    <script>
        // === CONFIGURATION (customize per chart) ===
        const LAYOUT = {
            col1: 60, col2: 280, col3: 500, col4: 720, col5: 940,
            row1: 60, row2: 180, row3: 300, row4: 420, row5: 540
        };

        const COLORS = {
            p1: { bg: 'linear-gradient(135deg, #3498db 0%, #2980b9 100%)', stroke: '#74b9ff' },
            p2: { bg: 'linear-gradient(135deg, #27ae60 0%, #219a52 100%)', stroke: '#55efc4' },
            p3: { bg: 'linear-gradient(135deg, #e67e22 0%, #d35400 100%)', stroke: '#fab1a0' },
            p4: { bg: 'linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%)', stroke: '#a29bfe' },
            init: { bg: 'linear-gradient(135deg, #636e72 0%, #555 100%)', stroke: '#95a5a6' },
            support: { bg: 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)', stroke: '#ff7675' }
        };

        // === NODE & EDGE DATA (customize per chart) ===
        const nodes = {
            // {{NODES_DATA}}
        };

        const edges = [
            // {{EDGES_DATA}}
        ];

        // === RENDERING ENGINE ===
        function render() {
            renderNodes();
            renderEdges();
        }

        function renderNodes() {
            const canvas = document.getElementById('canvas');
            Object.values(nodes).forEach(node => {
                const el = document.createElement('div');
                el.id = `node-${node.id}`;
                el.className = `node${node.isPattern ? ' pattern-node' : ''}`;
                el.style.left = `${node.x}px`;
                el.style.top = `${node.y}px`;
                el.style.width = `${node.width || 140}px`;
                el.style.height = `${node.height || 60}px`;

                if (!node.isPattern && COLORS[node.category]) {
                    el.style.background = COLORS[node.category].bg;
                }

                el.innerHTML = `
                    <div class="node-label">${node.label}</div>
                    ${node.sublabel ? `<div class="node-sublabel">${node.sublabel}</div>` : ''}
                `;

                el.onclick = () => selectNode(node.id);
                canvas.appendChild(el);
            });
        }

        function renderEdges() {
            const svg = document.getElementById('edges-svg');
            edges.forEach((edge, i) => {
                const from = nodes[edge.from];
                const to = nodes[edge.to];
                if (!from || !to) return;

                const start = getBorderPoint(from, to);
                const end = getBorderPoint(to, from);
                const ctrl = getControlPoint(start, end);

                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('class', 'edge');
                path.setAttribute('d', `M ${start.x} ${start.y} Q ${ctrl.x} ${ctrl.y} ${end.x} ${end.y}`);
                path.setAttribute('stroke', COLORS[edge.type]?.stroke || '#888');
                path.setAttribute('marker-end', 'url(#arrowhead)');
                svg.appendChild(path);

                if (edge.label) {
                    renderEdgeLabel(svg, start, end, ctrl, edge.label);
                }
            });
        }

        function getBorderPoint(from, to) {
            const cx = from.x + (from.width || 140) / 2;
            const cy = from.y + (from.height || 60) / 2;
            const tx = to.x + (to.width || 140) / 2;
            const ty = to.y + (to.height || 60) / 2;

            const dx = tx - cx;
            const dy = ty - cy;
            const halfW = ((from.width || 140) / 2) + 8;
            const halfH = ((from.height || 60) / 2) + 8;

            const angle = Math.atan2(dy, dx);
            const cornerAngle = Math.atan2(halfH, halfW);

            let x, y;
            if (Math.abs(angle) < cornerAngle || Math.abs(angle) > Math.PI - cornerAngle) {
                x = dx > 0 ? cx + halfW : cx - halfW;
                y = cy + halfW * Math.tan(angle) * (dx > 0 ? 1 : -1);
            } else {
                y = dy > 0 ? cy + halfH : cy - halfH;
                x = cx + halfH / Math.tan(angle) * (dy > 0 ? 1 : -1);
            }
            return { x, y };
        }

        function getControlPoint(start, end) {
            const midX = (start.x + end.x) / 2;
            const midY = (start.y + end.y) / 2;
            const dx = end.x - start.x;
            const dy = end.y - start.y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            const offset = Math.min(dist * 0.15, 40);

            if (Math.abs(dx) > Math.abs(dy)) {
                return { x: midX, y: midY - offset };
            } else {
                return { x: midX + offset, y: midY };
            }
        }

        function renderEdgeLabel(svg, start, end, ctrl, label) {
            const t = 0.5;
            const x = (1-t)*(1-t)*start.x + 2*(1-t)*t*ctrl.x + t*t*end.x;
            const y = (1-t)*(1-t)*start.y + 2*(1-t)*t*ctrl.y + t*t*end.y;

            const dx = end.x - start.x;
            const dy = end.y - start.y;
            const len = Math.sqrt(dx * dx + dy * dy);
            const offsetX = len ? (-dy / len) * 12 : 0;
            const offsetY = len ? (dx / len) * 12 : 0;

            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');

            const bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            bg.setAttribute('class', 'edge-label-bg');
            bg.setAttribute('x', x + offsetX - 20);
            bg.setAttribute('y', y + offsetY - 8);
            bg.setAttribute('width', 40);
            bg.setAttribute('height', 16);
            bg.setAttribute('rx', 4);

            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('class', 'edge-label');
            text.setAttribute('x', x + offsetX);
            text.setAttribute('y', y + offsetY + 4);
            text.setAttribute('text-anchor', 'middle');
            text.textContent = label;

            g.appendChild(bg);
            g.appendChild(text);
            svg.appendChild(g);
        }

        // === INTERACTIVITY ===
        function selectNode(nodeId) {
            document.querySelectorAll('.node.selected').forEach(n => n.classList.remove('selected'));
            document.getElementById(`node-${nodeId}`).classList.add('selected');

            const panel = document.getElementById('detail-panel');
            const node = nodes[nodeId];
            document.getElementById('detail-title').textContent = node.label;
            document.getElementById('detail-content').innerHTML = `
                <div class="detail-section">
                    <h3>Description</h3>
                    <p>${node.description || 'No description'}</p>
                </div>
            `;
            panel.classList.add('open');
        }

        function filterAll() {
            document.querySelectorAll('.node').forEach(n => n.classList.remove('disabled'));
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('open');
        }

        // === INIT ===
        document.addEventListener('DOMContentLoaded', render);
    </script>
</body>
</html>
